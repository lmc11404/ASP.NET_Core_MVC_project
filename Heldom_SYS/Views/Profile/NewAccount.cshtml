@* stylesheet *@
<link rel="stylesheet" href="~/css/Profile/NewAccount.css" />
@* https://localhost:7142/Profile/NewAccount *@

<div class="main_wrap border-radius box-shadow">
	<div class="top_area">
		<h4 class="bold">編輯員工資料</h4>
		<div class="form-check form-switch switch_wrap">
			<label class="form-check-label" for="flexSwitchCheckDefault" id="switch_txt">啟用中</label>
			<input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault" checked>
		</div>
	</div>
	<div class="middle_area">
		<div class="middle_area_left">
			<div class="photo_wrap">
				<p class="color-gray-dark bold p_width">員工照片</p>
				<div class="photo-box" id="photoBox">
					<div class="upload-area obj-center">
						<i class="fas fa-plus obj-center"></i>
					</div>
				</div>
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">員工姓名</p>
				<input id="employeeName" placeholder="姓名" class="form-control form-control-small" />
				<select id="Gender" class="form-select form-select-small">
					<option value="M" selected>男性</option>
					<option value="F">女性</option>
				</select>
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">出生日期</p>
				<input type="date" id="birthDate" class="form-control" />
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">聯絡電話</p>
				<input id="phone" placeholder="0919-123456" class="form-control"
					   pattern="[0-9]{4}-[0-9]{3}-[0-9]{3}" title="請輸入正確的手機號碼格式 (例如: 0919-123-456)" />
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">緊急聯絡人</p>
				<input id="emergencyContact" placeholder="聯絡人" class="form-control form-control-small" />
				<select id="relationship" class="form-select form-select-small">
					<option value="父" selected>父親</option>
					<option value="母">母親</option>
					<option value="丈夫">丈夫</option>
					<option value="妻子">妻子</option>
					<option value="其他">其他</option>
				</select>
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">緊急電話</p>
				<input id="emergencyPhone" placeholder="0919-123456" class="form-control" 
					   pattern="[0-9]{4}-[0-9]{3}-[0-9]{3}" title="請輸入正確的手機號碼格式 (例如: 0919-123-456)" />
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">到職日</p>
				<input type="date" class="form-control" id="hireDay" />
			</div>
		</div>
		<div class="middle_area_right">
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">員工編號</p>
				<input id="employeeId" placeholder="ABC-123456" class="form-control" disabled />
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">帳號權限</p>
				<select id="employeeRole" class="form-select form-select-big">
					<option value="M">管理權限</option>
					<option value="A">所有權限</option>
					<option value="E" selected>一般權限</option>
				</select>
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">部門</p>
				<select id="department" class="form-select form-select-big">
					<option selected>行政管理部</option>
					<option>工務管理部</option>
					<option>工務工程部</option>
				</select>
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">職稱</p>
				<select id="position" class="form-select form-select-big">
					<option>高層</option>
					<option>工地主任</option>
					<option selected>一般員工</option>
				</select>
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">直屬主管</p>
				<select id="ImmediateSupervisor" class="form-select form-select-big">
					<option selected>Peter</option>
					<option>Dave</option>
					<option>Shun</option>
					<option>Zoe</option>
					<option>Yao</option>
				</select>
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">地址</p>
				<input id="address" placeholder="台中市八德區公益路18號" class="form-control" />
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">電子郵件</p>
				<input type="email" id="mail" placeholder="123@gmail.com" class="form-control" />
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">設定密碼</p>
				<input type="password" id="password" class="form-control" />
				<span class="password-toggle" id="togglePassword"><i class="fas fa-eye"></i></span>
			</div>
			<div class="input_wrap">
				<p class="color-gray-dark bold p_width">離職日</p>
				<input type="date" class="form-control" id="resignDay" />
			</div>
		</div>
	</div>
	<div class="end_area obj-center">
		<button type="button" class="btn btn-outline" id="cancel-btn"><p class="color-blue">取消</p></button>
		<button type="button" class="btn btn-primary" id="save-btn"><p>儲存</p></button>
	</div>
</div>

<!-- 文件上傳輸入框 -->
<input type="file" class="form-control d-none" id="fileAdd" accept="image">

<!-- 儲存按鈕 Modal -->
<div id="clockPopup" class="modal clock-popup-wrap">
	<div class="modal-dialog clock-popup-content">
		<div class="modal-content">
			<div class="modal-header clock-top obj-vertical-center">
				<h5 class="modal-title color-gray-dark bold">提醒：為已離職人員</h5>
				<div class="clock-close obj-center"><i class="fas fa-times"></i></div>
			</div>
			<div class="modal-body clock-area">
				<h1 id="timeClock" class="color-gray-medium bold">提交後將關閉啟用狀態</h1>
				<h4 class="color-gray-dark bold">是否確認提交?</h4>
			</div>
			<div class="modal-footer clock-check">
				<button class="clock-button_cancel obj-center" id="no-Button">
					<p class="bold color-blue">否</p>
				</button>
				<button class="clock-button obj-center" id="yes-Button">
					<p class="bold color-white">是</p>
				</button>
			</div>
		</div>
	</div>
</div>

@* 圖片放大 *@
<div id="picturePopup" class="picture-popup-wrap">
	<div class="picture-popup-content">
		<img class="picture-img" src="#" alt="預覽圖片" />
	</div>
</div>

<script>
	// window.location.pathname;
	// => /Profile/NewAccount/E00004
	const myPathname = window.location.pathname.substring(20);
	const togglePassword = document.getElementById('togglePassword');
	const password = document.getElementById('password');
	let imgStr;

	$(document).ready(function() {

		GetData();
		uploadPhoto();
		popup();
		
	});
	let GetData = function(){
		
		if(window.location.pathname != '/profile/NewAccount'){
			// console.log(myPathname);
			$.ajax({
				url:'/Profile/GetSupervisor',
				type: 'GET',
				dataType: 'json',
				success: function(response) {
					if (response.length != 0) {
						setSupervisor(response);
					}
				},
				error: function(xhr, status, error) {

					console.error('Error fetching data:', error);
				}
			});
			$.ajax({
				url:'/Profile/GetAccountData',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(myPathname),
				dataType: 'json',
				success: function(response) {
					if (response.length != 0) {
						addEmployeeData(response);
						// 如果有初始照片，設置預覽
						if (imgStr!=null){
							updatePhotoPreview(imgStr);
						};
					}
				},
				error: function(xhr, status, error) {

					console.error('Error fetching data:', error);
				}
			});
		}else if(window.location.pathname == '/profile/NewAccount'){
			$.ajax({
				url:'/Profile/GetNewId',
				type: 'GET',
				dataType: 'json',
				success: function(response) {
					if (response.length != 0) {
						// console.log(response);
						const employee = response.data;
						$("#employeeId").prop('value', employee);
					}
				},
				error: function(xhr, status, error) {

					console.error('Error fetching data:', error);
				}
			});
			$.ajax({
				url:'/Profile/GetSupervisor',
				type: 'GET',
				dataType: 'json',
				success: function(response) {
					if (response.length != 0) {
						setSupervisor(response);
					}
				},
				error: function(xhr, status, error) {

					console.error('Error fetching data:', error);
				}
			});
		};
	}

	$('#save-btn').click(function(){
		let phoneNumber = $('#phone').val();
		let emergencyContactPhone = $('#emergencyPhone').val();
		const phonePattern = /^[0-9]{4}-[0-9]{3}-[0-9]{3}$/;
		if (!phonePattern.test(phoneNumber)||!phonePattern.test(emergencyContactPhone)) {
			alert("請輸入正確的手機號碼格式 (例如: 0919-123-456)");
			return;
		}

		let resignDayValue = $('#resignDay').val();
		let hireDayValue = $('#hireDay').val();
		let dateNow = Date.now();
		let resignDay = new Date(resignDayValue);
		let hireDay = new Date(hireDayValue);
		let months;
		let hours;
		
		if(resignDayValue != ""){
			if(dateNow > resignDay)
			{
				$("#clockPopup").fadeIn();
			};
		}else{
			let annualLeave = dateNow - hireDay;
			months = Math.floor(annualLeave / (1000 * 60 * 60 * 24 * 30));
			hours = calculateLeaveHours(months)
			// console.log(hours);
			createAccount(hours);
		}
	});

	$('#phone').on('input', function() {
		var input = this.value.replace(/\D/g, '').substring(0, 10);
		var formattedInput = input;
		if (input.length > 4 && input.length <= 7) {
			formattedInput = input.replace(/(\d{4})(\d{1,3})/, '$1-$2');
		}else if(input.length >= 7){
			formattedInput = input.replace(/(\d{4})(\d{3})(\d{1,3})/, '$1-$2-$3');
		}
		this.value = formattedInput;
	});
	$('#emergencyPhone').on('input', function() {
		var input = this.value.replace(/\D/g, '').substring(0, 10);
		var formattedInput = input;
		if (input.length > 4 && input.length <= 7) {
			formattedInput = input.replace(/(\d{4})(\d{1,3})/, '$1-$2');
		}else if(input.length >= 7){
			formattedInput = input.replace(/(\d{4})(\d{3})(\d{1,3})/, '$1-$2-$3');
		}
		this.value = formattedInput;
	});

	// popup確認按鈕
	$('#yes-Button').click(function(){
		let Hours = calculateHours();
		let resignDayValue = $('#resignDay').val();
		let resignDay = new Date(resignDayValue);
		let dateNow = Date.now();
		if(dateNow > resignDay){
			$('#flexSwitchCheckDefault').prop('checked',false);
		};
		createAccount(Hours);
	})

	// 取消按鈕
	$('#cancel-btn').click(function(){
		location.href = "/profile/Account";
	})

	// 密碼眼睛
	togglePassword.addEventListener('click', function() {
		const type = password.type === 'password' ? 'text' : 'password';
		password.type = type;
		const icon = this.querySelector('i');
		if (type === 'password') {
			icon.classList.remove('fa-eye-slash');
			icon.classList.add('fa-eye');
		} else {
			icon.classList.remove('fa-eye');
			icon.classList.add('fa-eye-slash');
		}
	});

	// 確認彈窗
	let popup = function Popup(){

		$(".clock-close").click(function(){
			$("#clockPopup").fadeOut();
		});

		$('#no-Button').click(function(){
			$("#clockPopup").fadeOut();
		})

		// 點擊背景區域關閉彈窗
		$("#clockPopup").click(function(event) {
			if(event.target === this) {
				$(this).fadeOut();
			}
		});
	}

	//啟用按鈕
	$('#flexSwitchCheckDefault').on('change', function() {
			
		if ($(this).prop('checked')) {
			$('#switch_txt').text('啟用中');
		} else {
			$('#switch_txt').text('停用中');
		}
	});

	// 照片上傳功能
	let uploadPhoto = function UploadPhoto(){
		// 點擊上傳區域觸發文件選擇
		$("#photoBox").on("click", function(e) {
			// 如果點擊的是刪除按鈕，不觸發文件選擇
			if (!$(e.target).hasClass('delete-icon')) {
				$("#fileAdd").click();
			}
		});

		// 監聽文件上傳
		$("#fileAdd").on("change", function(event) {
			let file = event.target.files[0];

			if (file && file.type.startsWith("image/")) {
				let reader = new FileReader();
				reader.onload = function(e) {
					imgStr = e.target.result;
					updatePhotoPreview(imgStr);
				};
				reader.readAsDataURL(file);
			} else {
				alert("請選擇圖片檔案");
			}
		});
	}

	// 更新照片預覽
	function updatePhotoPreview(imgSrc) {
		$(".upload-area").remove();
		$("#photoBox").html(`
			<div class="photo-container obj-center">
				<div class="error-icon obj-center">
					<i class="fas fa-times delete-icon"></i>
				</div>
				<img src="${imgSrc}" class="preview-img" id="imgload">
			</div>
		`);
		setupPhotoEvents();
	}

	// 設置照片相關事件
	function setupPhotoEvents() {
		// 刪除按鈕事件
		$(".delete-icon").on("click", function(e) {
			e.stopPropagation(); // 防止觸發圖片點擊事件
			imgStr = null;
			$("#photoBox").html(`
				<div class="upload-area obj-center">
					<i class="fas fa-plus obj-center"></i>
				</div>
			`);
		});

		// 圖片點擊放大事件
		$("#imgload").on("click", function(e) {
			e.stopPropagation(); // 防止觸發刪除按鈕事件
			$(".picture-img").prop("src", this.src);
			$("#picturePopup").fadeIn();
		});
	}

	// 圖片放大彈窗事件
	$(document).ready(function() {

		// 點擊背景關閉
		$("#picturePopup").click(function(event) {
			if (event.target === this) {
				$(this).fadeOut();
			}
		});

		// ESC鍵關閉
		$(document).keyup(function(e) {
			if (e.key === "Escape") {
				$("#picturePopup").fadeOut();
			}
		});

	});

	// 生成selector選項
	let setSupervisor = function(response){
		$("#ImmediateSupervisor").empty();
		for(let i = 0;i<response.length;i++){
			let option = document.createElement('option');
			option.textContent = response[i].employeeName;
			option.value = response[i].employeeId;
			$("#ImmediateSupervisor").append(option);
		};

		let firstOption = document.createElement('option');
		firstOption.textContent = '總經理';
		firstOption.setAttribute("id", "primium");
		firstOption.selected = true;
		$("#ImmediateSupervisor").append(firstOption);
	}

	function calculateHours(){
		let resignDayValue = $('#resignDay').val();
		let hireDayValue = $('#hireDay').val();
		let resignDay = new Date(resignDayValue);
		let hireDay = new Date(hireDayValue);
		let months;
		let hours;
		let annualLeave = resignDay - hireDay;
		months = Math.floor(annualLeave / (1000 * 60 * 60 * 24 * 30));
		hours = calculateLeaveHours(months);
		return hours;
	}

	// 假日計算
	function calculateLeaveHours(monthsOfService) {

		let yearsOfService = monthsOfService / 12; 

		let leaveHours = 0;

		if (monthsOfService >= 6 && yearsOfService < 1) {
			leaveHours = 24;
		} else if (yearsOfService >= 1 && yearsOfService < 2) {
			leaveHours = 56;
		} else if (yearsOfService >= 2 && yearsOfService < 3) {
			leaveHours = 80;
		} else if (yearsOfService >= 3 && yearsOfService < 5) {
			leaveHours = 112;
		} else if (yearsOfService >= 5 && yearsOfService < 10) {
			leaveHours = 120;
		} else if (yearsOfService >= 10) {
			leaveHours = Math.min(120 + (Math.floor(yearsOfService) - 10) * 8, 240);
		}
		
		return leaveHours;
	}

	// 存檔功能
	function createAccount(hours){
		// 檢查必填字段
		const requiredFields = {
			'employeeName': '員工姓名',
			'phone': '聯絡電話',
			'emergencyContact': '緊急聯絡人',
			'emergencyPhone': '緊急電話',
			'hireDay': '到職日',
			'mail': '電子郵件',
			'password': '密碼',
			'address': '地址',
			'birthDate': '出生日期'
		};

		// 驗證必填字段
		for (const [fieldId, fieldName] of Object.entries(requiredFields)) {
			const field = document.getElementById(fieldId);
			if (!field.value.trim()) {
				alert(`請填寫${fieldName}`);
				field.focus();
				return;
			}
		}
		
		let phoneNumber = $('#phone').val();
		let emergencyPhone = $('#emergencyPhone').val();
		let number = phoneNumber.slice(0,4) + phoneNumber.slice(5,8) + phoneNumber.slice(9);
		let emergency = emergencyPhone.slice(0,4) + emergencyPhone.slice(5,8) + emergencyPhone.slice(9);

		// 檢查照片
		const imgElement = document.getElementById('imgload');
		if (!imgElement) {
			alert('請上傳員工照片');
			return;
		}

		let photoString = $('#imgload').attr('src').split(",")[1];

		let editData = {
			EmployeePhoto : photoString,
			EmployeeName : $('#employeeName').val(),
			Gender : $('#Gender').val(),
			BirthDate : $('#birthDate').val(),
			PhoneNumber : number,
			EmergencyContact : $('#emergencyContact').val(),
			EmergencyRelationship : $('#relationship').val(),
			EmergencyContactPhone : emergency,
			HireDate : $('#hireDay').val(),
			IsActive : $('#flexSwitchCheckDefault').prop('checked'),
			EmployeeId : $('#employeeId').val(),
			PositionRole : $('#employeeRole').val(),
			Department : $('#department').val(),
			Position : $('#position').val(),
			ImmediateSupervisor : $('#ImmediateSupervisor').val(),
			Address : $('#address').val(),
			Mail : $('#mail').val(),
			Password : $('#password').val(),
			ResignationDate : $('#resignDay').val() || null,
			AnnualLeave : hours || 0
		}

		// 新增輸入驗證樣式
		function addValidationStyle() {
			const inputs = document.querySelectorAll('input[required]');
			inputs.forEach(input => {
				input.addEventListener('input', function() {
					if (this.value.trim()) {
						this.classList.remove('is-invalid');
						this.classList.add('is-valid');
					} else {
						this.classList.remove('is-valid');
						this.classList.add('is-invalid');
					}
				});
			});
		}

		// 在頁面載入時新增驗證樣式
		document.addEventListener('DOMContentLoaded', function() {
			addValidationStyle();
		});

		// 為必填欄位新增required屬性
		Object.keys(requiredFields).forEach(fieldId => {
			const field = document.getElementById(fieldId);
			if (field) {
				field.setAttribute('required', '');
			}
		});

		// console.log(dataEmployee);
		// console.log(editData);
		if(window.location.pathname != '/profile/NewAccount'){
			$.ajax({
				url: '/Profile/UpdateAccount',
				method: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(editData),
				success: function(response) {
					if (response) {
						alert('資料更新成功！');
						window.location.href = '/Profile/Account';
					} else {
						alert('更新失敗：' + response);
					}
				},
				error: function(error) {
					console.error('更新失敗：', error);
					alert('更新失敗，請稍後再試！');
				}
			});
		}else if(window.location.pathname == '/profile/NewAccount')
		{
			$.ajax({
				url: '/Profile/CreateAccount',
				method: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(editData),
				success: function(response) {
					if (response) {
						alert('資料更新成功！');
						window.location.href = '/Profile/Account';
					} else {
						console.log(response);
						alert('更新失敗：' + response);
					}
				},
				error: function(error) {
					console.error('更新失敗：', error);
					alert('更新失敗，請稍後再試！');
				}
			});
		}
	}
	let addEmployeeData = function(response){
		const employee = response[0];
		let resignDate;

		if(employee.resignationDate == null || employee.resignationDate == ""){
			resignDate = null;
		}else{
			resignDate = employee.resignationDate.substring(0,10);
		}

		$("#employeeId").prop('value', employee.employeeId);
		$('#flexSwitchCheckDefault').prop('checked',employee.isActive);
		$('#position').val(employee.position);
		$('#employeeRole').val(employee.positionRole);
		$('#hireDay').val(employee.hireDate.substring(0,10));
		$('#resignDay').val(resignDate);
		$('#department').val(employee.department);
		if(employee.immediateSupervisor == null){
			$('#primium').selected = true;
		}else{
			let setSupervisor = employee.immediateSupervisor;
			$('#ImmediateSupervisor').val(setSupervisor);
		}
		imgStr = "data:image/jpg;base64," + employee.employeePhoto;
		$('#employeeName').val(employee.employeeName);
		$('#phone').val((employee.phoneNumber.slice(0,4)+"-"+employee.phoneNumber.slice(4,7)+"-"+employee.phoneNumber.slice(7)));
		$('#mail').val(employee.mail);
		$('#password').val(employee.password);
		$('#address').val(employee.address);
		$('#Gender').val(employee.gender);
		$('#birthDate').val(employee.birthDate.substring(0,10));
		$('#emergencyContact').val(employee.emergencyContact);
		$('#relationship').val(employee.emergencyRelationship);
		$('#emergencyPhone').val((employee.emergencyContactPhone.slice(0,4)+"-"+employee.emergencyContactPhone.slice(4,7)+"-"+employee.emergencyContactPhone.slice(7)));
	}
</script>
